apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: tetragon-kafka-adapter
  namespace: falco
  labels:
    app: tetragon-kafka-adapter
spec:
  selector:
    matchLabels:
      app: tetragon-kafka-adapter
  template:
    metadata:
      labels:
        app: tetragon-kafka-adapter
    spec:
      # ⚠️ 重要：必须启用 hostNetwork 才能连接到 Tetragon 的 localhost:54321
      # 因为 Tetragon 使用 hostNetwork: true，监听在节点级别的 localhost:54321
      # ⭐ 使用 DaemonSet 的优势：
      #   - 每个节点一个 adapter 实例，自动一一对应
      #   - 每个实例连接本节点的 Tetragon（localhost:54321）
      #   - 不会出现端口冲突（DaemonSet 保证每个节点只有一个 Pod）
      #   - 不会出现重复事件（每个节点事件只被接收一次）
      hostNetwork: true
      # ⚠️ 使用 hostNetwork 时，必须配置 hostAliases，因为 Pod 使用宿主机的 /etc/hosts
      # 如果宿主机没有这些 DNS 映射，Pod 也无法解析
      hostAliases:
      # ⚠️ 所有 Kafka broker DNS 名称都解析到同一个 IP（根据 nslookup 结果）
      # DNS 解析：所有 broker 都解析到 172.30.32.85
      - ip: "172.30.32.85"
        hostnames:
        - "kafka-0.kafka.test-ebpay-mid.svc.cluster.local"
        - "kafka-1.kafka.test-ebpay-mid.svc.cluster.local"
        - "kafka-2.kafka.test-ebpay-mid.svc.cluster.local"
      containers:
      - name: adapter
        image: harbor.dcops.cc/library/tetragon-kafka-adapter:0.1.0
        imagePullPolicy: Always
        env:
        # Kubernetes 元数据（用于日志中）
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: NODE_IP
          valueFrom:
            fieldRef:
              fieldPath: status.hostIP
        volumeMounts:
        - name: config
          mountPath: /app/config.yaml
          subPath: config.yaml
          readOnly: true
        resources:
          # 资源请求（Guaranteed）
          requests:
            cpu: "100m"        # 0.5 核（最低保证）
            memory: "128Mi"    # 512 MB（最低保证）
          # 资源限制（最大使用）
          limits:
            cpu: "200m"       # 2 核（最大限制，高负载时使用）
            memory: "218Mi"      # 2 GB（最大限制，高负载时使用）
        livenessProbe:
          httpGet:
            path: /health
            port: 51345
            host: 127.0.0.1  # 使用 hostNetwork 时，必须指定 127.0.0.1
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /health
            port: 51345
            host: 127.0.0.1  # 使用 hostNetwork 时，必须指定 127.0.0.1
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        ports:
        - name: health
          containerPort: 51345
        - name: metrics
          containerPort: 51346
      volumes:
      - name: config
        configMap:
          name: tetragon-kafka-adapter-config
