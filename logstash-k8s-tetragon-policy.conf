input {  
  # Tetragon 事件 - 进程执行
  kafka {
    bootstrap_servers => "172.30.32.85:9092,172.30.32.85:9093,172.30.32.85:9094"
    topics => ["tetragon.process.exec"]
    group_id => "logstash-k8s-tetragon-process-exec"
    auto_offset_reset => "latest"
    codec => json
    decorate_events => true
  }
  
  # Tetragon 事件 - 进程退出
  kafka {
    bootstrap_servers => "172.30.32.85:9092,172.30.32.85:9093,172.30.32.85:9094"
    topics => ["tetragon.process.exit"]
    group_id => "logstash-k8s-tetragon-process-exit"
    auto_offset_reset => "latest"
    codec => json
    decorate_events => true
  }
  
  # Tetragon 事件 - 安全 LSM
  kafka {
    bootstrap_servers => "172.30.32.85:9092,172.30.32.85:9093,172.30.32.85:9094"
    topics => ["tetragon.security.lsm"]
    group_id => "logstash-k8s-tetragon-security-lsm"
    auto_offset_reset => "latest"
    codec => json
    decorate_events => true
  }
  
  # Tetragon 事件 - 系统调用 kprobe
  kafka {
    bootstrap_servers => "172.30.32.85:9092,172.30.32.85:9093,172.30.32.85:9094"
    topics => ["tetragon.syscall.kprobe"]
    group_id => "logstash-k8s-tetragon-syscall-kprobe"
    auto_offset_reset => "latest"
    codec => json
    decorate_events => true
  }
  
  # Tetragon 事件 - 内核 tracepoint
  kafka {
    bootstrap_servers => "172.30.32.85:9092,172.30.32.85:9093,172.30.32.85:9094"
    topics => ["tetragon.kernel.tracepoint"]
    group_id => "logstash-k8s-tetragon-kernel-tracepoint"
    auto_offset_reset => "latest"
    codec => json
    decorate_events => true
  }
  
  # Tetragon 事件 - 未知类型
  kafka {
    bootstrap_servers => "172.30.32.85:9092,172.30.32.85:9093,172.30.32.85:9094"
    topics => ["tetragon.unknown"]
    group_id => "logstash-k8s-tetragon-unknown"
    auto_offset_reset => "latest"
    codec => json
    decorate_events => true
  }
  
  # Tetragon 事件 - 死信队列
  kafka {
    bootstrap_servers => "172.30.32.85:9092,172.30.32.85:9093,172.30.32.85:9094"
    topics => ["tetragon.dlq"]
    group_id => "logstash-k8s-tetragon-dlq"
    auto_offset_reset => "latest"
    codec => json
    decorate_events => true
  }
}

filter {
  # 处理时间戳（基本处理，必需）
  if [ts] {
    date {
      match => ["ts", "ISO8601"]
      target => "@timestamp"
    }
  } else if [timestamp] {
    date {
      match => ["timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ", "yyyy-MM-dd'T'HH:mm:ssZ"]
      target => "@timestamp"
    }
  }
  
  if ![ts] and ![timestamp] {
    ruby {
      code => "event.set('@timestamp', Time.now)"
    }
  }
  
  # 生成索引日期（UTC+8，格式：YYYY.MM.dd）
  ruby {
    code => "event.set('index_date', event.get('@timestamp').time.localtime('+08:00').strftime('%Y.%m.%d'))"
  }
  
  # 不做任何过滤和处理，保留所有原始数据（包括 raw 字段）
  # 不做任何类型判断、字段提取和字段添加，直接保留原始数据
}

output {
  elasticsearch {
    user => "elastic"
    password => "c7jAJ-cA6Lw1MGeByfG9"
    hosts => ["http://172.30.32.71:9200", "http://172.30.32.72:9200", "http://172.30.32.73:9200", "http://172.30.32.74:9200", "http://172.30.32.75:9200"]
    index => "logstash-k8s-tetragon-policy-%{index_date}"
  }
}
